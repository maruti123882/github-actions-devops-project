name: DevOps CI-CD Pipeline

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: devops-app

jobs:
  build-test-push-deploy:
    runs-on: ubuntu-latest

    steps:

    # ---------------------------
    # Step 1: Checkout Source Code
    # ---------------------------
    - name: Checkout Code
      uses: actions/checkout@v3

    # ---------------------------
    # Step 2: Run Tests (Before Build)
    # ---------------------------
    - name: Run Unit Tests
      run: |
        echo "Running tests..."
        # Example for Python
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
          pytest || exit 1
        fi

        # Example for Node
        if [ -f package.json ]; then
          npm install
          npm test || exit 1
        fi

    # ---------------------------
    # Step 3: Set Image Tag (Git SHA)
    # ---------------------------
    - name: Set Image Tag
      run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

    # ---------------------------
    # Step 4: Docker Login
    # ---------------------------
    - name: Docker Login
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login \
        -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

    # ---------------------------
    # Step 5: Build Docker Image
    # ---------------------------
    - name: Build Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
        docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
        ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

    # ---------------------------
    # Step 6: Push Docker Images
    # ---------------------------
    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

    # ---------------------------
    # Step 7: Setup Kubectl
    # ---------------------------
    - name: Setup Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    # ---------------------------
    # Step 8: Configure Kubeconfig
    # ---------------------------
    - name: Configure Kubernetes Credentials
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config

    # ---------------------------
    # Step 9: Update Image in K8s YAML
    # ---------------------------
    - name: Update Kubernetes Image
      run: |
        sed -i "s|IMAGE_PLACEHOLDER|${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}|g" k8s-deployment.yaml

    # ---------------------------
    # Step 10: Deploy to Kubernetes
    # ---------------------------
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s-deployment.yaml
        kubectl rollout status deployment/devops-app
