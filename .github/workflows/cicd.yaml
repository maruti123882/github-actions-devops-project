name: Docker CI Pipeline

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: devops-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:

    # Step 1 - Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v3

    # Step 2 - Set Image Tag
    - name: Set Image Tag
      run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

    # Step 3 - Docker Login
    - name: Docker Login
      run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

    # Step 4 - Build Docker Image
    - name: Build Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
        docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
        ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

    # Step 5 - Push Docker Image
    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
